name: Cypress Integration Test Workflow

on:
    workflow_dispatch:
      inputs:
        commit_sha:
          description: 'Commit sha: from your branch' 
          required: true 
        product:
          description: 'App: Your target product directory within src/applications'
          required: true
        # TO-DO: create a solution that maintains an updated list of active products within src/applications
  
env:
    VETS_WEBSITE_CHANNEL_ID: ''
  
jobs:
    integration-test:
      name: Test setup
      runs-on: ubuntu-latest
      permissions: write-all
      outputs:
        ECR_USERNAME: ${{ steps.login-ecr.outputs.docker_username_008577686731_dkr_ecr_us_gov_west_1_amazonaws_com }}
        ECR_PASSWORD: ${{ steps.login-ecr.outputs.docker_password_008577686731_dkr_ecr_us_gov_west_1_amazonaws_com }}
      steps:
        - name: Checkout
          uses: actions/checkout@cd7d8d697e10461458bc61a30d094dc601a8b017
          with:
           fetch-depth: 0
          
        - name: Determine slackGroup and specPattern
          id: helper
          run: |
             chmod +x ./script/github-actions/cypress-integration-test.sh 
             ./script/github-actions/cypress-integration-test.sh "${{ github.event.inputs.product }}"

        - name: Configure AWS Credentials
          uses: aws-actions/configure-aws-credentials@v4.0.0
          with:
             aws-region: us-gov-west-1
             role-to-assume: arn:aws-us-gov:iam::008577686731:role/gha-frontend-nonprod-role
        
        - name: Login to Amazon ECR
          id: login-ecr
          uses: aws-actions/amazon-ecr-login@v2    
          with:
            mask-password: false

        - name: Get va-vsp-bot token
          uses: ./.github/workflows/inject-secrets
          with:
            ssm_parameter: /devops/VA_VSP_BOT_GITHUB_TOKEN
            env_variable_name: VA_VSP_BOT_GITHUB_TOKEN

        - name: Find the build
          id: find-build
          run: |
            ARCHIVE_NAME=${{ github.event.inputs.commit_sha }}/vagovprod.tar.bz2
            BUCKET_PATH=s3://vetsgov-website-builds-s3-upload/
            
            df -H
            aws s3 cp $BUCKET_PATH$ARCHIVE_NAME .
            echo "1"
            
            mkdir vets-website
            tar -xvjf vagovprod.tar.bz2 -C vets-website
            echo "2"
      
    run-cypress-test:
      name: 
      runs-on: ubuntu-latest
      needs: integration-test
      container: 
        image: 008577686731.dkr.ecr.us-gov-west-1.amazonaws.com/dsva/cypress-io/cypress/browsers:node16.16.0-chrome107-ff107-edge
        credentials: 
          username: ${{ needs.integration-test.outputs.ECR_USERNAME }}
          password: ${{ needs.integration-test.outputs.ECR_PASSWORD }}
      steps:

      - name: Call reusable action
        id: cypress-action
        uses: department-of-veterans-affairs/vsp-github-actions/cypress-integration-test@cypress-integration-test-migration