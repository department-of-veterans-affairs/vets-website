name: Freeze Enforcer

on:
  schedule:
    - cron: 0 10 * * 1-5
  workflow_dispatch:
    inputs:
      bypass_freeze:
        description: 'Bypass holiday freeze enforcer'
        required: false
        default: 'false'

env:
  VETS_WEBSITE_CHANNEL_ID: C02V265VCGH # status-vets-website
  COP_AND_SRE_CHANNELS: 'C04868KS69L, C06JM7UUHE3' # Frontend COP & platform-sre-team

jobs:
  holiday-checker:
    runs-on: ubuntu-latest
    outputs:
      is_holiday: ${{ steps.holiday-check.outputs.is_holiday }}
    steps:
    - name: Check if today is a holiday
      id: holiday-check
      uses: department-of-veterans-affairs/vsp-github-actions/holiday-checker@main

  enforce-freeze:
    runs-on: ubuntu-latest
    needs: holiday-checker
    if: ${{ github.event.inputs.bypass_freeze != 'true' && needs.holiday-checker.outputs.is_holiday == 'true' }}
    steps:
      - name: Disable content-build daily deploy
        run: |
          echo "Holiday detected â€“ disabling content-build daily production deploy."
          curl -X PATCH -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/department-of-veterans-affairs/content-build/actions/workflows/daily-deploy-production.yml/disable

  notify-freeze-enabled:
    name: Notify Freeze Enabled (Early)
    runs-on: ubuntu-latest
    needs: [holiday-checker, enforce-freeze]
    if: ${{ github.event.inputs.bypass_freeze != 'true' && needs.holiday-checker.outputs.is_holiday == 'true' }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@cd7d8d697e10461458bc61a30d094dc601a8b017

      - name: Notify Slack - Code Freeze Enabled (Early)
        uses: ./.github/workflows/slack-notify
        continue-on-error: true
        with:
          payload: '{"attachments": [{"color": "#FFA500", "blocks": [{"type": "section","text": {"type": "mrkdwn", "text": "ðŸš« *Code Freeze Enabled:* Holiday freeze is active. Deployment workflows for `vets-website` and `content-build` are disabled/gated. No deployments should occur until further notice."}}]}]}'
          channel_id: ${{ env.COP_AND_SRE_CHANNELS }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}


