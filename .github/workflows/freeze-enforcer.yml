name: Freeze Enforcer

on:
  schedule:
    - cron: 0 10 * * 1-5
  workflow_dispatch:
    inputs:
      bypass_freeze:
        description: 'Bypass holiday freeze enforcer'
        required: false
        default: 'false'

env:
  VETS_WEBSITE_CHANNEL_ID: C02V265VCGH # status-vets-website
  COP_CHANNEL_ID: C04868KS69L
  SRE_CHANNEL_ID: C06JM7UUHE3

jobs:
  holiday-checker:
    runs-on: ubuntu-latest
    outputs:
      is_holiday: ${{ steps.holiday-check.outputs.is_holiday }}
    steps:
    - name: Check if today is a holiday
      id: holiday-check
      uses: department-of-veterans-affairs/vsp-github-actions/holiday-checker@main

  enforce-freeze:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    needs: holiday-checker
    if: ${{ github.event.inputs.bypass_freeze != 'true' && needs.holiday-checker.outputs.is_holiday == 'true' }}
    steps:
      - name: Configure AWS credentials for secret injection
        uses: ./.github/workflows/configure-aws-credentials
        with:
          aws_region: us-gov-west-1
          role: ${{ vars.AWS_ASSUME_ROLE }}

      - name: Get bot token from Parameter Store
        uses: ./.github/workflows/inject-secrets
        with:
          ssm_parameter: /devops/VA_VSP_BOT_GITHUB_TOKEN
          env_variable_name: VA_VSP_BOT_GITHUB_TOKEN

      - name: Disable content-build daily deploy
        run: |
          echo "Holiday detected â€“ disabling content-build daily production deploy."
          curl -X PATCH -H "Authorization: token ${VA_VSP_BOT_GITHUB_TOKEN:-${{ secrets.GITHUB_TOKEN }}}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/department-of-veterans-affairs/content-build/actions/workflows/daily-production-release.yml/disable

  notify-freeze-enabled:
    name: Notify Freeze Enabled (Early)
    runs-on: ubuntu-latest
    needs: [holiday-checker, enforce-freeze]
    permissions:
      id-token: write
      contents: read
    if: ${{ github.event.inputs.bypass_freeze != 'true' && needs.holiday-checker.outputs.is_holiday == 'true' }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@cd7d8d697e10461458bc61a30d094dc601a8b017

      - name: Notify Slack (COP) - Code Freeze Enabled (Early)
        uses: ./.github/workflows/slack-notify
        continue-on-error: false
        with:
          payload: '{"attachments": [{"color": "#FFA500", "blocks": [{"type": "section","text": {"type": "mrkdwn", "text": "ðŸš« *Code Freeze Enabled:* Holiday freeze is active. Deployment workflows for `vets-website` and `content-build` are disabled/gated. No deployments should occur until further notice."}}]}]}'
          channel_id: ${{ env.COP_CHANNEL_ID }}
          role: ${{ vars.AWS_ASSUME_ROLE }}

      - name: Short delay before SRE Slack (Enabled)
        run: sleep 2

      - name: Notify Slack (SRE) - Code Freeze Enabled (Early)
        uses: ./.github/workflows/slack-notify
        continue-on-error: false
        with:
          payload: '{"attachments": [{"color": "#FFA500", "blocks": [{"type": "section","text": {"type": "mrkdwn", "text": "ðŸš« *Code Freeze Enabled:* Holiday freeze is active. Deployment workflows for `vets-website` and `content-build` are disabled/gated. No deployments should occur until further notice."}}]}]}'
          channel_id: ${{ env.SRE_CHANNEL_ID }}
          role: ${{ vars.AWS_ASSUME_ROLE }}


