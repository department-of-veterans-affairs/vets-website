name: Test Condition Evaluation

on:
  push:
    branches:
      - fix/cd-prod-deploy-condition

jobs:
  set-output:
    name: Set Output to No
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.set.outputs.value }}
      # This simulates what the broken syntax effectively does - pre-evaluating to a string
      broken_condition: ${{ startsWith(steps.set.outputs.value, 'yes') }}
    steps:
      - name: Set output to no
        id: set
        run: echo "value=no" >> $GITHUB_OUTPUT

      - name: Log outputs
        run: |
          echo "Output value is '${{ steps.set.outputs.value }}'"
          echo "Broken condition (pre-evaluated) is '${{ startsWith(steps.set.outputs.value, 'yes') }}'"

  # This simulates what happens with: if: always() && ${{ expr }}
  # The ${{ expr }} gets pre-evaluated to a STRING "false", and "false" as a string is truthy
  test-broken-syntax:
    name: "BROKEN: String 'false' is truthy"
    runs-on: ubuntu-latest
    needs: [set-output]
    if: always() && needs.set-output.outputs.broken_condition
    steps:
      - name: This should NOT run but will due to string truthiness
        run: |
          echo "BUG - This job ran!"
          echo "broken_condition value: '${{ needs.set-output.outputs.broken_condition }}'"
          echo "The string 'false' is truthy in expression evaluation"

  # This is the correct syntax - evaluate the condition directly
  test-fixed-syntax:
    name: "FIXED: Proper boolean evaluation"
    runs-on: ubuntu-latest
    needs: [set-output]
    if: always() && startsWith(needs.set-output.outputs.should_run, 'yes')
    steps:
      - name: This should NOT run
        run: echo "BUG - This job ran even though should_run='no'"

  # Control test - this should run because 'yes' starts with 'yes'
  test-control-yes:
    name: "CONTROL: Should run with 'yes'"
    runs-on: ubuntu-latest
    needs: [set-output]
    if: always() && startsWith('yes-test', 'yes')
    steps:
      - name: This SHOULD run
        run: echo "OK - This job ran as expected with 'yes'"
