# NOTE: This workflow has been intentionally disabled. The CD production
# deploy pipeline is currently not in use. If re-enabling, also uncomment
# the cd-prod-deploy job in continuous-integration.yml.
#
# name: Continuous Deploy Production
#
# on:
#   repository_dispatch:
#     types: [cd-production-deploy]
#
# run-name: "Triggered by: ${{ github.event.client_payload.entry_app }} commit: ${{ github.event.client_payload.github_sha }}"
#
# concurrency:
#   group: deploy-${{ github.event.client_payload.concurrency_group }}
#   cancel-in-progress: true
#
# jobs:
#   notify-pending-deployment:
#     name: Notify of Pending Deployment
#     if: ${{ github.event.client_payload.github_ref == 'refs/heads/main' }}
#     runs-on: ubuntu-latest
#     permissions:
#       id-token: write
#       contents: read
#     env:
#       VETS_WEBSITE_CHANNEL_ID: C02V265VCGH #status-vets-website
#
#     steps:
#       - name: Checkout
#         uses: actions/checkout@cd7d8d697e10461458bc61a30d094dc601a8b017
#
#       - name: Notify application team in Slack
#         uses: ./.github/workflows/slack-notify
#         with:
#           payload: >
#             {
#               "attachments": [
#                 {
#                   "color": "#FFCC00",
#                   "blocks": [
#                     {
#                       "type": "section",
#                       "text": {
#                         "type": "mrkdwn",
#                         "text": "A deployment for ${{ github.event.client_payload.entry_app }} is awaiting approval on the `main` branch in `vets-website`: <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|${{ github.event.client_payload.entry_app }} commit: ${{ github.event.client_payload.github_sha }}>\n\nFor help troubleshooting, see the <https://depo-platform-documentation.scrollhelp.site/developer-docs/continuous-deployment|documentation> on deployments."
#                       }
#                     }
#                   ]
#                 }
#               ]
#             }
#           channel_id: ${{ github.event.client_payload.slack_channel != '' && github.event.client_payload.slack_channel || env.VETS_WEBSITE_CHANNEL_ID }}
#           role: ${{ vars.AWS_ASSUME_ROLE }}
#
#   deploy:
#     name: Deploy
#     if: ${{ github.event.client_payload.github_ref == 'refs/heads/main' }}
#     needs: [notify-pending-deployment]
#     runs-on: ubuntu-latest
#     permissions:
#       id-token: write
#       contents: read
#     environment: production-cd
#     outputs:
#       started: ${{ steps.start_check.outputs.started }}
#
#     steps:
#       - name: Mark job started
#         id: start_check
#         run: echo "started=true" >> $GITHUB_OUTPUT
#       - name: Checkout
#         uses: actions/checkout@cd7d8d697e10461458bc61a30d094dc601a8b017
#         with:
#           fetch-depth: 0
#
#       - name: Install dependencies
#         uses: ./.github/workflows/install
#         timeout-minutes: 30
#         with:
#           key: ${{ hashFiles('yarn.lock') }}
#           yarn_cache_folder: .cache/yarn
#           path: |
#             .cache/yarn
#             node_modules
#
#       - name: Check if commit can be deployed
#         id: check-deployability
#         run: node ./script/github-actions/check-deployability.js
#         env:
#           BUILDTYPE: vagovprod
#
#       - name: Configure AWS credentials
#         if: steps.check-deployability.outputs.is_deployable == 'true'
#         uses: ./.github/workflows/configure-aws-credentials
#         with:
#           aws_region: us-gov-west-1
#           role: ${{ vars.AWS_ASSUME_ROLE }}
#
#       - name: Deploy
#         if: steps.check-deployability.outputs.is_deployable == 'true'
#         run: ./script/github-actions/partial-deploy.sh -s $SRC -d $DEST -a $ASSET_DEST -v
#
#         env:
#           SRC: s3://vetsgov-website-builds-s3-upload/${{ github.event.client_payload.github_sha }}/vagovprod.tar.bz2
#           DEST: s3://www.va.gov
#           ASSET_DEST: s3://prod-va-gov-assets
#
#   notify-success:
#     name: Notify Success
#     runs-on: ubuntu-latest
#     if: ${{ github.ref == 'refs/heads/main' && success() }}
#     needs: [deploy]
#     permissions:
#       id-token: write
#       contents: read
#     env:
#       VETS_WEBSITE_CHANNEL_ID: C02V265VCGH #status-vets-website
#
#     steps:
#       - name: Checkout
#         uses: actions/checkout@cd7d8d697e10461458bc61a30d094dc601a8b017
#
#       - name: Notify Slack - Deployment Succeeded
#         uses: ./.github/workflows/slack-notify
#         with:
#           payload: >-
#             {
#               "attachments": [
#                 {
#                   "color": "#2eb886",
#                   "blocks": [
#                     {
#                       "type": "section",
#                       "text": {
#                         "type": "mrkdwn",
#                         "text": "Deployment for ${{ github.event.client_payload.entry_app }} succeeded on the `main` branch in `vets-website`: <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|run details>"
#                       }
#                     }
#                   ]
#                 }
#               ]
#             }
#           channel_id: ${{ github.event.client_payload.slack_channel != '' && github.event.client_payload.slack_channel || env.VETS_WEBSITE_CHANNEL_ID }}
#           role: ${{ vars.AWS_ASSUME_ROLE }}
#
#   notify-failure:
#     name: Notify Failure
#     runs-on: ubuntu-latest
#     if: ${{ always() && github.ref == 'refs/heads/main' && (failure() || cancelled()) }}
#     needs: [deploy]
#     permissions:
#       id-token: write
#       contents: read
#     env:
#       VETS_WEBSITE_CHANNEL_ID: C02V265VCGH #status-vets-website
#
#     steps:
#       - name: Checkout
#         uses: actions/checkout@cd7d8d697e10461458bc61a30d094dc601a8b017
#
#       - name: Slack – Deployment rejected (not approved)
#         if: ${{ needs.deploy.result == 'failure' && needs.deploy.outputs.started == '' }}
#         uses: ./.github/workflows/slack-notify
#         continue-on-error: true
#         with:
#           payload: >-
#             {
#               "attachments": [
#                 {
#                   "color": "#FF0800",
#                   "blocks": [
#                     {
#                       "type": "section",
#                       "text": {
#                         "type": "mrkdwn",
#                         "text": ":x: Deployment for ${{ github.event.client_payload.entry_app }} to production was *rejected*.\n*Commit:* `${{ github.event.client_payload.github_sha }}` – <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|run details>"
#                       }
#                     }
#                   ]
#                 }
#               ]
#             }
#           channel_id: ${{ github.event.client_payload.slack_channel != '' && github.event.client_payload.slack_channel || env.VETS_WEBSITE_CHANNEL_ID }}
#           role: ${{ vars.AWS_ASSUME_ROLE }}
#
#       - name: Slack – Deployment expired (no approval)
#         if: ${{ needs.deploy.result == 'cancelled' && needs.deploy.outputs.started == '' }}
#         uses: ./.github/workflows/slack-notify
#         continue-on-error: true
#         with:
#           payload: >-
#             {
#               "attachments": [
#                 {
#                   "color": "#FFCC00",
#                   "blocks": [
#                     {
#                       "type": "section",
#                       "text": {
#                         "type": "mrkdwn",
#                         "text": ":warning: Deployment for ${{ github.event.client_payload.entry_app }} *expired without approval* (or was cancelled before approval).\n*Commit:* `${{ github.event.client_payload.github_sha }}` – <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|run details>"
#                       }
#                     }
#                   ]
#                 }
#               ]
#             }
#           channel_id: ${{ github.event.client_payload.slack_channel != '' && github.event.client_payload.slack_channel || env.VETS_WEBSITE_CHANNEL_ID }}
#           role: ${{ vars.AWS_ASSUME_ROLE }}
#
#       - name: Slack – Deployment cancelled during execution
#         if: ${{ needs.deploy.result == 'cancelled' && needs.deploy.outputs.started == 'true' }}
#         uses: ./.github/workflows/slack-notify
#         continue-on-error: true
#         with:
#           payload: >-
#             {
#               "attachments": [
#                 {
#                   "color": "#A9A9A9",
#                   "blocks": [
#                     {
#                       "type": "section",
#                       "text": {
#                         "type": "mrkdwn",
#                         "text": ":stop_sign: Deployment for ${{ github.event.client_payload.entry_app }} was *cancelled during execution*.\n*Commit:* `${{ github.event.client_payload.github_sha }}` – <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|run details>"
#                       }
#                     }
#                   ]
#                 }
#               ]
#             }
#           channel_id: ${{ github.event.client_payload.slack_channel != '' && github.event.client_payload.slack_channel || env.VETS_WEBSITE_CHANNEL_ID }}
#           role: ${{ vars.AWS_ASSUME_ROLE }}
#
#       - name: Slack – Deployment failed (error during run)
#         if: ${{ needs.deploy.result == 'failure' && needs.deploy.outputs.started == 'true' }}
#         uses: ./.github/workflows/slack-notify
#         continue-on-error: true
#         with:
#           payload: >-
#             {
#               "attachments": [
#                 {
#                   "color": "#FF0800",
#                   "blocks": [
#                     {
#                       "type": "section",
#                       "text": {
#                         "type": "mrkdwn",
#                         "text": ":x: Deployment for ${{ github.event.client_payload.entry_app }} *failed due to a code or system error*.\n*Commit:* `${{ github.event.client_payload.github_sha }}` – <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|run details>"
#                       }
#                     }
#                   ]
#                 }
#               ]
#             }
#           channel_id: ${{ github.event.client_payload.slack_channel != '' && github.event.client_payload.slack_channel || env.VETS_WEBSITE_CHANNEL_ID }}
#           role: ${{ vars.AWS_ASSUME_ROLE }}
