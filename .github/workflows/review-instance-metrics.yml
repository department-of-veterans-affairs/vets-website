name: Review Instance Metrics

on:
  repository_dispatch:
    types: [review_instance_run]

jobs:
  collect-review-instance-metrics:
    name: Collect Review Instance Metrics
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@cd7d8d697e10461458bc61a30d094dc601a8b017

      - name: Configure AWS credentials
        uses: ./.github/workflows/configure-aws-credentials
        with:
          aws_region: us-gov-west-1
          role: ${{ vars.AWS_ASSUME_ROLE }}

      - name: Get va-vsp-bot token
        uses: ./.github/workflows/inject-secrets
        with:
          ssm_parameter: /devops/VA_VSP_BOT_GITHUB_TOKEN
          env_variable_name: VA_VSP_BOT_GITHUB_TOKEN

      - name: Init Dashboard Data Repo
        uses: ./.github/workflows/init-data-repo

      - name: Set Up BigQuery Creds
        uses: ./.github/workflows/configure-bigquery

      - name: Log Review Instance Status
        run: yarn log-review-instance
        working-directory: qa-standards-dashboard-data
        env:
          API_BRANCH: ${{ github.event.client_payload.api_branch }}
          WEB_BRANCH: ${{ github.event.client_payload.web_branch }}
          CONTENT_BRANCH: ${{ github.event.client_payload.content_branch }}
          DEPLOYMENT_ID: ${{ github.event.client_payload.deployment_id }}
          INSTANCE_STATUS: ${{ github.event.client_payload.instance_status }}
          ERROR: ${{ github.event.client_payload.error }}
