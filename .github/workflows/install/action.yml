name: Install Dependencies
description: Install Dependencies

# TODO: Is this the right name/desc?

# TODO: Would be nice to add `if` for NEXUS
inputs:
  # nexus_registry:
  #   description: Enable NEXUS registry
  #   required: false
  #   default: false
  keys:
    description: keys for actions/cache@v2
    required: false
    default: ''
  restore-keys:
    description: restore-keys for actions/cache@v2
    required: false
    default: ''
  yarn_cache_folder:
    description: path for yarn cache
    required: false
    default: ''
  path:
    description: path for cache folders
    required: false
    default: ''

runs:
  using: composite
  steps:
    - name: Get Node version
      id: get-node-version
      shell: bash
      run: echo ::set-output name=NODE_VERSION::$(cat .nvmrc)

    - name: Setup Node
      uses: actions/setup-node@v2
      with:
        node-version: ${{ steps.get-node-version.outputs.NODE_VERSION }}

    - name: Cache dependencies
      id: cache-dependencies
      uses: actions/cache@v2
      with:
        path: ${{ inputs.path }}
        key: ${{ steps.get-node-version.outputs.NODE_VERSION }}-${{ inputs.keys }}
        restore-keys: ${{ steps.get-node-version.outputs.NODE_VERSION }}-${{ inputs.restore-keys }}

    # - name: Get NEXUS username
    #   if: ${{ inputs.nexus_registry == true }}
    #   uses: marvinpinto/action-inject-ssm-secrets@v1.1.1
    #   with:
    #     ssm_parameter: /devops/VA_VSP_BOT_1_NEXUS_USERNAME
    #     env_variable_name: VA_VSP_BOT_1_NEXUS_USERNAME

    # - name: Get NEXUS token
    #   if: ${{ inputs.nexus_registry == true }}
    #   uses: marvinpinto/action-inject-ssm-secrets@v1.1.1
    #   with:
    #     ssm_parameter: /devops/VA_VSP_BOT_1_NEXUS_PASSWORD
    #     env_variable_name: VA_VSP_BOT_1_NEXUS_PASSWORD

    # # Required to change registry in yarn.lock file
    # - name: Change registry in yarn.lock
    #   if: ${{ inputs.nexus_registry == true }}
    #   shell: bash
    #   run: |
    #     sed -i -e "s#https://registry.yarnpkg.com/#${{ env.NEXUS_REGISTRY }}#g" yarn.lock
    #     sed -i -e "s#https://registry.npmjs.org/#${{ env.NEXUS_REGISTRY }}#g" yarn.lock

    # - name: Authenticate NEXUS
    #   if: ${{ inputs.nexus_registry == true }}
    #   shell: bash
    #   run: |
    #     npm config set _auth $(echo -n '${{ env.VA_VSP_BOT_1_NEXUS_USERNAME }}:${{ env.VA_VSP_BOT_1_NEXUS_PASSWORD }}' | openssl base64)
    #     npm config set cafile ${{ env.NODE_EXTRA_CA_CERTS }}
    #     npm config set registry ${{ env.NEXUS_REGISTRY }}
    #     npm config set email va-vsp-bot-1@va.gov
    #     npm config set always-auth true

    - name: Install dependencies
      uses: nick-invision/retry@v2
      with:
        command: yarn install --frozen-lockfile --prefer-offline --production=false --network-concurrency 1
        max_attempts: 3
        timeout_minutes: 7
      env:
        YARN_CACHE_FOLDER: ${{ inputs.yarn_cache_folder }}
